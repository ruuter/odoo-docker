#!/bin/bash -

set -eu

VERSIONS=("12.0" "13.0" "14.0")
RELEASE=${1-$(date +'%Y%m%d')}

if grep -q ODOO_RELEASE=$RELEASE 12.0/Dockerfile; then
    echo "Already up-to-date!"
    exit 0
fi

echo "Updating to release $RELEASE ..."
for version in ${VERSIONS[@]}; do
    debfile=${version}.deb

    if [ ! -f $debfile ]; then
        curl -o $debfile -sSL --fail http://nightly.odoo.com/${version}/nightly/deb/odoo_${version}.${RELEASE}_all.deb
    fi

    shasum=$(sha1sum $debfile | cut -d ' ' -f1)

    sed -i "/^ARG ODOO_RELEASE/s/[0-9]*$/${RELEASE}/" ${version}/Dockerfile
    sed -i "/^ARG ODOO_SHA/s/[a-z0-9]*$/${shasum}/" ${version}/Dockerfile

    git add ${version}
    rm $debfile
done

git commit -m "[REF] Odoo 12.0-14.0: update to release ${RELEASE}"

exit 0
